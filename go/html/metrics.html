<div class="fade-in">
    <!-- Header Card -->
    <div class="card mb-4">
        <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div class="d-flex align-items-center">
                <div class="bg-light p-3 rounded-circle me-3 text-primary flex-shrink-0">
                    <i class="fa-solid fa-server fa-2x"></i>
                </div>
                <div style="min-width: 0;">
                    <h4 class="mb-0 fw-bold text-truncate">{{.Meta.Name}}</h4>
                    <div class="text-muted small text-truncate"><i class="fa-solid fa-fingerprint me-1"></i>{{.UUID}}</div>
                </div>
            </div>
            
            {{if ge .Permission 2}}
            <div class="d-flex align-items-center gap-2 ms-auto">
                 <button class="btn btn-outline-primary btn-sm text-nowrap"
                         hx-post="/device/token/refresh?uuid={{.UUID}}"
                         hx-confirm="确定要重置该设备的 Token 吗？这将导致设备断开连接。">
                    <i class="fa-solid fa-key me-1"></i><span class="d-none d-sm-inline">重置令牌</span>
                </button>
                
                <!-- Settings Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-light btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa-solid fa-gear text-secondary"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                        <li><h6 class="dropdown-header text-uppercase small fw-bold">危险操作</h6></li>
                        <li>
                            <button class="dropdown-item text-danger"
                                    hx-post="/device/revoke?uuid={{.UUID}}"
                                    hx-confirm="确定要吊销该设备的认证吗？设备将无法连接。"
                                    hx-target="body">
                                <i class="fa-solid fa-ban me-2"></i>吊销认证
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item text-danger"
                                    hx-post="/device/delete?uuid={{.UUID}}"
                                    hx-confirm="确定要永久删除该设备吗？所有历史数据将丢失且无法恢复！"
                                    hx-target="body">
                                <i class="fa-solid fa-trash-can me-2"></i>删除设备
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Info Grid - Compact on Mobile -->
    <div class="row g-2 g-md-4 mb-4">
        <div class="col-6 col-md-3">
            <div class="card h-100 border-0 shadow-sm bg-white">
                <div class="card-body p-3">
                    <h6 class="text-uppercase text-muted small fw-bold mb-1" style="font-size: 0.7rem;">硬件版本</h6>
                    <div class="fs-6 fw-semibold">{{.Meta.HWVersion}}</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100 border-0 shadow-sm bg-white">
                <div class="card-body p-3">
                    <h6 class="text-uppercase text-muted small fw-bold mb-1" style="font-size: 0.7rem;">软件版本</h6>
                    <div class="fs-6 fw-semibold">{{.Meta.SWVersion}}</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100 border-0 shadow-sm bg-white">
                <div class="card-body p-3">
                    <h6 class="text-uppercase text-muted small fw-bold mb-1" style="font-size: 0.7rem;">序列号</h6>
                    <div class="fs-6 fw-semibold text-truncate" title="{{.Meta.SerialNumber}}">{{.Meta.SerialNumber}}</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100 border-0 shadow-sm bg-white">
                <div class="card-body p-3">
                    <h6 class="text-uppercase text-muted small fw-bold mb-1" style="font-size: 0.7rem;">MAC 地址</h6>
                    <div class="fs-6 fw-semibold text-truncate" title="{{.Meta.MACAddress}}">{{.Meta.MACAddress}}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body p-3">
            <h6 class="text-uppercase text-muted small fw-bold mb-2" style="font-size: 0.7rem;">当前访问令牌</h6>
            <div class="bg-light p-2 rounded d-flex justify-content-between align-items-center">
                {{if ge .Permission 2}}
                <code class="text-break text-dark small">{{.Meta.Token}}</code>
                <i class="fa-regular fa-copy text-muted ms-2 p-1" style="cursor: pointer;" onclick="navigator.clipboard.writeText('{{.Meta.Token}}')"></i>
                {{else}}
                <code class="text-break text-muted small">******** (权限不足)</code>
                {{end}}
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="card mb-4 chart-container">
        <div class="card-header bg-white border-0 pt-3 px-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold fs-6"><i class="fa-solid fa-chart-area me-2 text-primary"></i>数据监控</h5>
            <div class="dropdown d-md-none">
                 <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                     <i class="fa-solid fa-clock"></i>
                 </button>
                 <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                     {{ $uuid := .UUID }}
                     {{ $range := .Range }}
                     {{ range $r, $label := dict "1h" "1小时" "6h" "6小时" "24h" "24小时" "7d" "7天" "all" "全部" }}
                     <li><a class="dropdown-item {{if eq $range $r}}active{{end}}" href="#"
                        hx-get="/metrics/{{$uuid}}?range={{$r}}" 
                        hx-target="#main-view" 
                        hx-swap="innerHTML">{{$label}}</a></li>
                     {{ end }}
                 </ul>
            </div>
            <div class="btn-group btn-group-sm d-none d-md-inline-flex">
                {{ $uuid := .UUID }}
                {{ $range := .Range }}
                {{ range $r, $label := dict "1h" "1小时" "6h" "6小时" "24h" "24小时" "7d" "7天" "all" "全部" }}
                <button class="btn btn-outline-secondary {{if eq $range $r}}active{{end}}"
                   hx-get="/metrics/{{$uuid}}?range={{$r}}" 
                   hx-target="#main-view" 
                   hx-swap="innerHTML">
                   {{$label}}
                </button>
                {{ end }}
            </div>
        </div>
        <div class="card-body p-2 p-md-3">
            {{if .Metrics}}
            <div class="chart-wrapper">
                <canvas id="metricsChart"></canvas>
            </div>
            <style>
                .chart-wrapper { position: relative; width: 100%; height: 350px; }
                @media (max-width: 768px) { .chart-wrapper { height: 250px; } }
            </style>
            {{else}}
            <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted" style="height: 350px;">
                <i class="fa-solid fa-chart-simple fa-3x mb-3 text-light"></i>
                <p>该时间段内暂无数据</p>
            </div>
            {{end}}
        </div>
    </div>

    {{if .Metrics}}
    <script>
      (function() {
        var ctx = document.getElementById('metricsChart');
        if (!ctx) return;

        if (window.myMetricsChart instanceof Chart) {
            window.myMetricsChart.destroy();
            window.myMetricsChart = null;
        }

        // Process Data
        // Type: 1=Temp, 2=Humi, 4=Lux
        const rawData = [
            {{range .Metrics}}
            { t: {{.Timestamp}}, v: {{.Value}}, type: {{.Type}} },
            {{end}}
        ];

        const tempData = rawData.filter(d => d.type === 1).map(d => ({ x: d.t, y: d.v }));
        const humiData = rawData.filter(d => d.type === 2).map(d => ({ x: d.t, y: d.v }));
        const luxData  = rawData.filter(d => d.type === 4).map(d => ({ x: d.t, y: d.v }));

        window.myMetricsChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: '温度 (°C)',
                        data: tempData,
                        borderColor: '#ff595e', // Red
                        backgroundColor: '#ff595e1A',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y'
                    },
                    {
                        label: '湿度 (%)',
                        data: humiData,
                        borderColor: '#4361ee', // Blue
                        backgroundColor: '#4361ee1A',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y'
                    },
                    {
                        label: '光照 (Lux)',
                        data: luxData,
                        borderColor: '#f7b801', // Yellow
                        backgroundColor: '#f7b8011A',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y1' // Use separate axis for Lux as it has large range
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: 'MM-dd HH:mm',
                                day: 'MM-dd'
                            }
                        },
                        grid: { display: false },
                        ticks: { color: '#adb5bd', maxTicksLimit: 8 }
                    },
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        title: { display: true, text: '温湿度' },
                        grid: { color: '#f1f3f5' }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        title: { display: true, text: '光照' },
                        grid: { drawOnChartArea: false } // Avoid grid overlap
                    }
                },
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1);
                                }
                                return label;
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
      })();
    </script>
    {{end}}
</div>
